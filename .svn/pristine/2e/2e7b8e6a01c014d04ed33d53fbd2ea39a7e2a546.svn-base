package kr.caincheon.church.admin.dao;

import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.log4j.Logger;
import org.springframework.stereotype.Repository;

import kr.caincheon.church.common.CommonDaoDTO;
import kr.caincheon.church.common.CommonNBoard;
import kr.caincheon.church.common.Const;


@Repository("nBoardDao")
public class NBoardDaoImpl extends CommonNBoard implements NBoardDao {

	private final Logger _logger = Logger.getLogger(getClass());
	
	@Override
	public void nboardList(CommonDaoDTO dto, Map _params, String left_menu_data_pg, int attachedFileMaxCount) throws Exception {
		
		String query = "", queryList="";
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO Called.[params:"+_params+", menu="+left_menu_data_pg+"]" );
		
		// paging
		int pageNo    = ipnull(_params, "pageNo", 1);
		int pageSize  = ipnull(_params, "pageSize", 10);
		int startRnum = (pageNo - 1) * pageSize + 1;
		int endRnum   = pageNo * pageSize;
		
		// Query Combination
		try {
			boolean isViewPage = false;
			query   = getSQLSelectNBoard(_params, isViewPage, attachedFileMaxCount);
			
			// total count
			dto.daoTotalCount = super.executeCount("SELECT COUNT(1) FROM ( " + query + " ) A ", false);
			
			
			// list 
			queryList = "SELECT B.NAME AS CATEGORY_NAME, ISNULL(C.NAME,'') AS CHURCH_NAME, ISNULL(D.NAME,'') AS DEPART_NAME, ISNULL(O.NAME, '') AS ORG_NAME"
					+ ", A.* FROM ( "
					+ query
					+ " ) A "
					+ " LEFT OUTER JOIN "+DB_OWNER+".NBOARD_CATEGORY B ON B.C_IDX      = A.C_IDX      AND B.B_IDX=A.B_IDX AND B.IS_USE='Y' "
					+ " LEFT OUTER JOIN "+DB_OWNER+".ORG_HIERARCHY   O ON O.ORG_IDX    = A.DEPART_IDX "
					+ " LEFT OUTER JOIN "+DB_OWNER+".CHURCH          C ON C.CHURCH_IDX = A.CHURCH_IDX " 
					+ " LEFT OUTER JOIN "+DB_OWNER+".DEPARTMENT      D ON D.DEPART_IDX = A.DEPART_IDX "
					
					+ " WHERE RNUM BETWEEN " + startRnum + " AND " + endRnum
					+ " ORDER BY A.NOTICE_TYPE, A.REGDATE DESC, A.BL_IDX DESC ";
			
			dto.daoList = super.executeQueryList(queryList);

		} catch (Exception e) {
			_E(_logger, Thread.currentThread().getStackTrace(), "SQL ERROR:"+e.getMessage()+"]", e );
			throw e;
		} finally {
			free();
		}
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO Result.[DTO:"+dto+"]" );
	}

/*
	@Override
	public int nboardListCount(Map _params, String menu) {
//		String b_idx = pnull(_params, "searchGubun1", "ALL");
//		String idxGroup = "", strWhere="";
		int result=0;
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO Called.[params:"+_params+"]" );

		// 게시판 판별 :: b_idx 코드 가져오기
//		idxGroup = getBIdxsInBoardCategory(menu);
		
		//
		String query = "";
//		String schText = pnull(_params, "searchText");
//		String schTextGubun = pnull(_params, "searchGubun2");
//		String depart_idx = pnull(_params, "depart_idx");
//		String church_idx = pnull(_params, "church_idx");
		

//		if (schText.length() > 0)
//			if (schTextGubun.equalsIgnoreCase("ALL"))
//				strWhere = " AND (TITLE LIKE '%" + schText + "%' OR CONTENT LIKE '%" + schText + "%')";
//			else
//				strWhere = " AND " + schTextGubun + " LIKE '%" + schText + "%' ";
//		
//		if (depart_idx.length() > 0 && menu.equals("church")) strWhere = strWhere + " AND depart_idx = '" + depart_idx + "' ";
//		if (church_idx.length() > 0 && menu.equals("church")) strWhere = strWhere + " AND church_idx = '" + church_idx + "' ";
		
		try {
//			String b_idx_cause = " C_IDX=(SELECT C_IDX FROM "+DB_OWNER+".NBOARD_CATEGORY WHERE B_IDX="+b_idx+" AND C_IDX>22 AND IS_USE='Y') ";
//			if (b_idx.equalsIgnoreCase("ALL") || b_idx.length() == 0)
//				b_idx_cause = " C_IDX=(SELECT C_IDX FROM "+DB_OWNER+".NBOARD_CATEGORY WHERE B_IDX IN ("+idxGroup+") AND C_IDX>22 AND IS_USE='Y') ";

			// 쿼리성능 개선을 위해, 서브쿼리가 아닌 별도 쿼리로 변경
//			b_idx_cause  = this.getCIdxsQuery( (b_idx.equalsIgnoreCase("ALL") || b_idx.length() == 0 ? idxGroup : b_idx) );
//			
//			if (b_idx.equalsIgnoreCase("ALL") || b_idx.length() == 0)
//				query = "SELECT COUNT(1) FROM ("
//						+ "  SELECT ROW_NUMBER() OVER(ORDER BY NOTICE_TYPE, REF DESC, STEP) RNUM, B_IDX  "
//						+ "  FROM ( "
//						+ "     SELECT TOP 2 '1' AS NOTICE_TYPE, A.* FROM (SELECT top 50 *  FROM "+DB_OWNER+".NBOARD  WHERE "+b_idx_cause+strWhere+" AND  IS_NOTICE='Y' ORDER BY BL_IDX DESC) A "
//						+ "     UNION ALL  "
//						+ "     SELECT '2' AS NOTICE_TYPE, *  FROM "+DB_OWNER+".NBOARD WHERE "+b_idx_cause+strWhere +" AND BL_IDX NOT IN (SELECT TOP 50 BL_IDX FROM "+DB_OWNER+".NBOARD WHERE "+b_idx_cause+strWhere+" AND  IS_NOTICE='Y' ORDER BY BL_IDX DESC) "
//						+ "  ) A1  "
//						+ ") A ";
//			else
//				query = "SELECT COUNT(1) FROM ("
//						+ "  SELECT ROW_NUMBER() OVER(ORDER BY NOTICE_TYPE, REF DESC, STEP) RNUM, B_IDX "
//						+ "  FROM ("
//						+ "    SELECT TOP 2 '1' AS NOTICE_TYPE, A.* FROM (SELECT top 50 *  FROM "+DB_OWNER+".NBOARD  WHERE B_IDX=" + b_idx+" "+strWhere+" AND IS_NOTICE='Y' ORDER BY BL_IDX DESC) A "
//						+ "    UNION ALL  "
//						+ "    SELECT '2' AS NOTICE_TYPE, * FROM "+DB_OWNER+".NBOARD  WHERE "+b_idx_cause+strWhere+" "+" AND BL_IDX NOT IN (SELECT TOP 50 BL_IDX FROM "+DB_OWNER+".NBOARD WHERE "+b_idx_cause+strWhere+" AND IS_NOTICE='Y' ORDER BY BL_IDX DESC) "
//						+"   ) A1 "
//						+ ") A ";
			boolean isViewPage = false;
			query = "SELECT COUNT(1) FROM ( " + getSelectSQLNBoard(_params, isViewPage, menu, 1) + " ) A ";
			result = super.executeCount(query, false);
			
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			free();
		}

		return result;
	}
	*/

	@Override
	public void nboardContents(CommonDaoDTO dto, Map _params, int attachedFileMaxCount)  throws Exception  {
		
		String query = "";
		try {
			boolean isViewPage = true;
			query = "SELECT * FROM ( " + getSQLSelectNBoard(_params, isViewPage, attachedFileMaxCount) + " ) A ";
			dto.daoDetailContent = super.executeQueryMap(query);
			
			// super admin except
			Object oMap = _params.get(SESSION_MAP);
			String admMemId = pnull(  (Map)oMap, Const.SESSION_KEY_ADM_MEM_ID );
			if( !"admin".equalsIgnoreCase(admMemId) ) {
				super.executeUpdate("UPDATE "+DB_OWNER+".NBOARD SET HIT=HIT+1 WHERE BL_IDX='"+pnull(_params, "bl_idx")+"'");
			}
		} catch (Exception e) {
			throw e;
		} finally {
			free();
		}
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO Result.[DTO:"+dto+"]" );
	}

	/*
	 * 관리자 이름을 조회하기
	 */
	private Map getMember(Map _params)  throws Exception {
		Map result = null;
		try {
			String query = "SELECT ADM_NAME AS NAME FROM "+DB_OWNER+".ADMMEMBER WHERE ADM_ID='"+_params.get("user_id")+"' ";
			result = super.executeQueryMap(query);
		} catch (Exception e) {
			throw e;
		} finally {
		}
		if(result==null) result = new HashMap();
		return result;
	}

	/*
	 * NBOARD 등록
	 * (non-Javadoc)
	 * @see kr.caincheon.church.admin.dao.NBoardDao#nboardInsert(java.util.Map, java.util.List)
	 */
	@Override
	public boolean nboardInsert(Map _params, List uploadedFiles)  throws Exception {
		D(_logger, Thread.currentThread().getStackTrace(), "DAO nboardInsert Called.[params:"+_params+"]" );
		
		int r=-1;
		try {
			// 게시글 등록 & 첨부파일 등록 
			r = executeInsertNBoard( _params,  uploadedFiles, getClass().getSimpleName()+".nboardInsert()");
			// 첨부파일 등록
//			String registerId = pnull(getMember(_params), "NAME");
//			insertNboardUpload( _params,  uploadedFiles, registerId);
		} catch (SQLException e) {
			
			throw e;
		} finally {
			free();
		}
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO nboardInsert Return.[result:"+r+"]" );
		return r > 0 ? true : false;
	}

	/*
	 * NBOARD 게시물 수정
	 * (non-Javadoc)
	 * @see kr.caincheon.church.admin.dao.NBoardDao#nboardModify(java.util.Map, java.util.List)
	 */
	@Override
	public boolean nboardModify(Map _params, List uploadedFiles)  throws Exception {
		int rn = 0, rn1 = 0, rn2 = 0, rn3 = 0, rn4 = 0;
		
		PreparedStatement preparedStatement = null;
		boolean bReturn = true;
		
		D(_logger, Thread.currentThread().getStackTrace(), "DAO Called.[params:"+_params+", uploadedFiles:"+uploadedFiles+"]" );
		
		// 작성자
		String updateId = pnull(_params, "user_id");
		String registerNm = "";
		
		// from login session
		// 작성자 , 일반사용자라면, MEM_ID로 저장되고, super admin 이면 ADM_MEM_ID로 저장된다.
		Map _AdmMap = (Map)_params.get("__SESSION_MAP__");
		String writerId = pnull(_AdmMap, Const.SESSION_KEY_MEM_ID, pnull(_AdmMap, Const.SESSION_KEY_ADM_MEM_ID));
		String writerNm = pnull(_AdmMap, Const.SESSION_KEY_MEM_NM, pnull(_AdmMap, Const.SESSION_KEY_ADM_MEM_NM));
		if(writerId.length()>0) {
			updateId = writerId;
		}
		if(writerNm.length()>0) {
			registerNm = writerNm;
		} else {
			registerNm = pnull(getMember(_params), "NAME", updateId);
		}

		// delete old files
		deleteAttachedFilesNboardUpload(_params);
		
		// new files upload
		if(uploadedFiles.size() > 0) {
			insertAttachedFilesNboardUpload( _params,  uploadedFiles, registerNm);
		}
		
		// board update
		try {
			String depart_idx = pnull(_params, "depart_idx"); 
			String b_idx      = pnull(_params, "b_idx"); 
			String c_idx      = pnull(_params, "c_idx", "SELECT TOP 1 ISNULL(C_IDX,'') FROM "+DB_OWNER+".NBOARD_CATEGORY WHERE B_IDX="+b_idx+" AND IS_USE='Y'"); 
			String is_view    = pnull(_params, "is_view"); 
			String church_idx = pnull(_params, "church_idx"); 
			int i = 1;
			//LinkedHashMap<String, String> lhm = new LinkedHashMap<String, String>();
			String query = "UPDATE "+DB_OWNER+".NBOARD SET  title= ?, content = ?,  update_id = ?,  is_notice = ?, event_date = ?"
					+ ", down_level = ?, b_idx = " + b_idx
					+ ", upddate = getdate()"
					+ (is_view.length()    == 0 ? "" : ", is_view='"+is_view+"' ")
					+ (depart_idx.length() == 0 ? "" : ", depart_idx = "+depart_idx)
					+ (church_idx.length() == 0 ? "" : ", church_idx = "+church_idx)
					+ ", c_idx =(" + c_idx + ") "
					+ " WHERE bl_idx = ? ";
			
			preparedStatement = getPreparedStatement(query);
			preparedStatement.setString(i++,  pnull(_params, "title"));
			preparedStatement.setString(i++,  pnull(_params, "contents"));
			preparedStatement.setString(i++,  updateId);
			//preparedStatement.setString(i++,  registerNm);
			preparedStatement.setString(i++,  pnull(_params, "is_notice", "N"));
			preparedStatement.setString(i++,  pnull(_params, "event_date"));
			preparedStatement.setString(i++,  pnull(_params, "down_level", "A"));
			preparedStatement.setString(i++,  pnull(_params, "bl_idx"));
			rn3 = preparedStatement.executeUpdate();

			D(_logger, Thread.currentThread().getStackTrace(), "query executed result count rn3 : "+rn3 );
			
		} catch (Exception e) {
			e.printStackTrace();
			bReturn = false;
		} finally {
			if (preparedStatement != null) {
				try {
					preparedStatement.close();
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
			free();
		}

		rn = rn1 + rn2 + rn3 + rn4;
		return rn >= 1 && bReturn;
	}

	/*
	 * NBOARD 게시물 삭제
	 * (non-Javadoc)
	 * @see kr.caincheon.church.admin.dao.NBoardDao#nboardDelete(java.util.Map)
	 */
	@Override
	public boolean nboardDelete(Map _params)  throws Exception {
		int rn = 0;
		String bl_idx = pnull(_params, "bl_idx", "0");

		D(_logger, Thread.currentThread().getStackTrace(), "DAO Called.[params:"+_params+"]" );

		// 게시물 삭제
		try {
			rn = executeUpdate("DELETE FROM "+DB_OWNER+".NBOARD WHERE BL_IDX="+bl_idx);
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
		}

		
		// 첨부 파일 삭제
		//List delFileList = executeQueryList("SELECT * FROM "+DB_OWNER+".NBOARD_UPLOAD WHERE BL_IDX="+bl_idx) ;
		deleteAttachedFilesNboardUpload(_params);
		
		// 첨부 데이터 삭제
		try {
			rn += executeUpdate("DELETE FROM "+DB_OWNER+".NBOARD_UPLOAD WHERE BL_IDX="+bl_idx);
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			free();
		}

		return rn >= 1;
	}

}
